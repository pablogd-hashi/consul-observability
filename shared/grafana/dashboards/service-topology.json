{
  "title": "Service Topology",
  "uid": "service-topology",
  "tags": ["consul", "mesh", "topology"],
  "timezone": "browser",
  "schemaVersion": 38,
  "refresh": "15s",
  "time": { "from": "now-15m", "to": "now" },
  "panels": [
    {
      "id": 1,
      "title": "Service Map (Node Graph)",
      "description": "Live service-to-service communication topology from distributed traces",
      "type": "nodeGraph",
      "gridPos": { "h": 16, "w": 24, "x": 0, "y": 0 },
      "datasource": { "type": "jaeger", "uid": "jaeger" },
      "targets": [
        {
          "datasource": { "type": "jaeger", "uid": "jaeger" },
          "queryType": "dependencyGraph",
          "refId": "A"
        }
      ]
    },
    {
      "id": 2,
      "title": "Request Rate — example-app (req/s)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "color": { "mode": "palette-classic" }
        }
      },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "rate(envoy_http_inbound_http_rq_total[1m])",
          "legendFormat": "inbound req/s",
          "refId": "A"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "rate(envoy_cluster_upstream_rq_total{envoy_cluster_name=\"local_app\"}[1m])",
          "legendFormat": "upstream → example-app req/s",
          "refId": "B"
        }
      ]
    },
    {
      "id": 3,
      "title": "P99 Latency — Envoy → example-app (ms)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "ms",
          "color": { "mode": "palette-classic" }
        }
      },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "histogram_quantile(0.99, rate(envoy_cluster_upstream_rq_time_bucket{envoy_cluster_name=\"local_app\"}[2m]))",
          "legendFormat": "p99 latency",
          "refId": "A"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "histogram_quantile(0.50, rate(envoy_cluster_upstream_rq_time_bucket{envoy_cluster_name=\"local_app\"}[2m]))",
          "legendFormat": "p50 latency",
          "refId": "B"
        }
      ]
    },
    {
      "id": 4,
      "title": "Error Rate — 5xx responses",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "color": { "mode": "palette-classic" },
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 0.01 }
            ]
          }
        }
      },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "rate(envoy_cluster_upstream_rq_xx{envoy_response_code_class=\"5\"}[1m]) / rate(envoy_cluster_upstream_rq_total[1m])",
          "legendFormat": "5xx error rate",
          "refId": "A"
        }
      ]
    },
    {
      "id": 5,
      "title": "Consul Service Health",
      "type": "stat",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "mappings": [
            { "options": { "0": { "text": "FAILING" }, "1": { "text": "PASSING" } }, "type": "value" }
          ],
          "thresholds": {
            "steps": [
              { "color": "red", "value": null },
              { "color": "green", "value": 1 }
            ]
          },
          "color": { "mode": "thresholds" }
        }
      },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "expr": "consul_health_service_status{service_name=~\"example-app|backend-api\",status=\"passing\"}",
          "legendFormat": "{{service_name}}",
          "refId": "A"
        }
      ]
    },
    {
      "id": 6,
      "title": "Recent Traces (Loki — Envoy Access Log)",
      "type": "logs",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 32 },
      "datasource": { "type": "loki", "uid": "loki" },
      "options": {
        "showTime": true,
        "sortOrder": "Descending",
        "wrapLogMessage": false
      },
      "targets": [
        {
          "datasource": { "type": "loki", "uid": "loki" },
          "expr": "{service_name=\"envoy-sidecar\"}",
          "refId": "A"
        }
      ]
    }
  ]
}
