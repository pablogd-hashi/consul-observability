# kubernetes/observability/grafana.yaml
# Grafana with pre-provisioned datasources and official HashiCorp proxy-metrics dashboards.
# Dashboards sourced from:
#   https://github.com/hashicorp-education/learn-consul-proxy-metrics/tree/main/dashboards
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: observability
data:
  data-plane-health.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "target": {
              "limit": 100,
              "matchAny": false,
              "tags": [],
              "type": "dashboard"
            },
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "#EAB839",
                    "value": 5
                  },
                  {
                    "color": "green",
                    "value": 6
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 9,
            "x": 0,
            "y": 0
          },
          "id": 65,
          "options": {
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "showThresholdLabels": false,
            "showThresholdMarkers": true
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(envoy_server_live{app!=\"traffic-generator\"})",
              "instant": false,
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Running HashiCups services",
          "type": "gauge"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 10,
            "x": 9,
            "y": 0
          },
          "id": 61,
          "options": {
            "legend": {
              "calcs": [
                "max",
                "mean",
                "lastNotNull"
              ],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "rate(envoy_listener_downstream_cx_overload_reject{}[$__interval])",
              "hide": false,
              "instant": false,
              "interval": "3m",
              "legendFormat": "{{namespace}} : {{consul_source_service}}-{{envoy_listener_address}}-overload",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "rate(envoy_listener_downstream_global_cx_overflow{}[$__interval])",
              "hide": false,
              "interval": "3m",
              "legendFormat": "{{namespace}} : {{consul_source_service}}-{{envoy_listener_address}}-overflow",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Connections Rejected",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "links": [],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 9,
            "x": 0,
            "y": 7
          },
          "id": 70,
          "links": [],
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "none"
            }
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "builder",
              "exemplar": true,
              "expr": "sum by(app, envoy_cluster_name) (envoy_cluster_upstream_cx_active{consul_destination_namespace=\"$namespace\"})",
              "format": "time_series",
              "interval": "",
              "intervalFactor": 2,
              "legendFormat": "{{envoy_cluster_name}} ({{service}})",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Total active upstream connections",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 10,
            "x": 9,
            "y": 7
          },
          "id": 41,
          "options": {
            "legend": {
              "calcs": [
                "last",
                "sum"
              ],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "sortBy": "Last",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum by(namespace,app,envoy_response_code_class) (rate(envoy_cluster_upstream_rq_xx[5m]))",
              "legendFormat": "{{namespace}} : {{app}}-{{envoy_response_code_class}}xx",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Upstream Rq by Status Code",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 10,
            "x": 9,
            "y": 14
          },
          "id": 51,
          "options": {
            "legend": {
              "calcs": [
                "last",
                "sum"
              ],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "sortBy": "Last",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_http_downstream_rq_xx{envoy_http_conn_manager_prefix=\"public_listener\"}[5m])) by (namespace, app,envoy_response_code_class)\n",
              "legendFormat": "{{namespace}} : {{app}}-{{envoy_response_code_class}}xx",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Downstream Rq by Status Code",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "links": [],
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 9,
            "x": 0,
            "y": 15
          },
          "id": 71,
          "links": [],
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "none"
            }
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "exemplar": true,
              "expr": "sum(envoy_http_downstream_cx_active{app=~\"$app\"}) by (app)",
              "format": "time_series",
              "interval": "",
              "intervalFactor": 2,
              "legendFormat": "{{service}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Total active HTTP downstream connections",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 6,
            "w": 14,
            "x": 0,
            "y": 22
          },
          "id": 47,
          "options": {
            "legend": {
              "calcs": [
                "sum"
              ],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "sortBy": "Total",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum by(app, envoy_response_code_class) (increase(envoy_http_downstream_rq_xx{envoy_http_conn_manager_prefix=\"public_listener\", namespace=~\"$namespace\", app=~\"$app\"}[5m]))",
              "legendFormat": "{{app}}-{{envoy_response_code_class}}xx",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "HTTP Status ( $app )",
          "type": "timeseries"
        }
      ],
      "refresh": "",
      "revision": 1,
      "schemaVersion": 38,
      "style": "dark",
      "tags": [],
      "templating": {
        "list": [
          {
            "current": {
              "selected": true,
              "text": "default",
              "value": "default"
            },
            "hide": 0,
            "includeAll": false,
            "multi": false,
            "name": "namespace",
            "options": [
              {
                "selected": true,
                "text": "default",
                "value": "default"
              },
              {
                "selected": false,
                "text": "consul",
                "value": "consul"
              }
            ],
            "query": "default, consul",
            "queryValue": "",
            "skipUrlSync": false,
            "type": "custom"
          },
          {
            "current": {
              "selected": false,
              "text": "All",
              "value": "$__all"
            },
            "datasource": {
              "type": "prometheus",
              "uid": "PBFA97CFB590B2093"
            },
            "definition": "label_values(app)",
            "hide": 0,
            "includeAll": true,
            "multi": false,
            "name": "app",
            "options": [],
            "query": {
              "query": "label_values(app)",
              "refId": "PrometheusVariableQueryEditor-VariableQuery"
            },
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "sort": 0,
            "type": "query"
          }
        ]
      },
      "time": {
        "from": "now-5m",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "",
      "title": "Data Plane Health",
      "uid": "data-plane-health",
      "version": 1,
      "weekStart": ""
    }
  data-plane-performance.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "target": {
              "limit": 100,
              "matchAny": false,
              "tags": [],
              "type": "dashboard"
            },
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": 3,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 0,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 7,
            "x": 0,
            "y": 0
          },
          "id": 49,
          "options": {
            "displayMode": "gradient",
            "minVizHeight": 10,
            "minVizWidth": 0,
            "orientation": "horizontal",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "showUnfilled": true,
            "valueMode": "color"
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "100 * max (container_memory_working_set_bytes{namespace=~\"$namespace\"} / on(container, pod) label_replace(kube_pod_container_resource_limits{resource=\"memory\"}, \"pod\", \"$1\", \"exported_pod\", \"(.+)\")) by (pod)",
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Mem Usage % by pod limits",
          "type": "bargauge"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 1,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "#EAB839",
                    "value": 60
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 7,
            "x": 7,
            "y": 0
          },
          "id": 28,
          "options": {
            "displayMode": "gradient",
            "minVizHeight": 10,
            "minVizWidth": 0,
            "orientation": "horizontal",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "showUnfilled": true,
            "valueMode": "color"
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "100 * max(\n  rate(container_cpu_usage_seconds_total{namespace=~\"$namespace\"}[5m])\n    / on (container, pod)\n  label_replace(kube_pod_container_resource_limits{resource=\"cpu\"}, \"pod\", \"$1\", \"exported_pod\", \"(.+)\")\n) by (pod)",
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "CPU Usage %  by pod limits",
          "type": "bargauge"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "noValue": "0",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 32
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 3,
            "x": 14,
            "y": 0
          },
          "id": 58,
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "text": {
              "titleSize": 12
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "sum by (app) (envoy_cluster_upstream_cx_active{app=\"$app\",namespace=~\"$namespace\",envoy_cluster_name!~\"consul-dataplane|prometheus.*|local_app|original-.*\"})",
              "instant": true,
              "legendFormat": "{{envoy_cluster_name}}",
              "range": false,
              "refId": "A"
            }
          ],
          "title": "Connections ( $app )",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "#EAB839",
                    "value": 0.00001
                  },
                  {
                    "color": "red",
                    "value": 0.00002
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 7,
            "x": 17,
            "y": 0
          },
          "id": 18,
          "options": {
            "legend": {
              "calcs": [
                "last"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Last",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "rate(container_cpu_cfs_throttled_seconds_total{namespace=~\"$namespace\"}[5m])",
              "legendFormat": "{{pod}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "CPU Throttled seconds by pod",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 3,
            "x": 14,
            "y": 4
          },
          "id": 64,
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "center",
            "orientation": "horizontal",
            "reduceOptions": {
              "calcs": [
                "last"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "value_and_name"
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_http_downstream_rq_total{namespace=~\"$namespace\",envoy_http_conn_manager_prefix=\"public_listener\"}[5m])) by (namespace)\n",
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Requests / sec",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 2,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "#EAB839",
                    "value": 5
                  },
                  {
                    "color": "orange",
                    "value": 8
                  },
                  {
                    "color": "red",
                    "value": 10
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 6,
            "w": 24,
            "x": 0,
            "y": 8
          },
          "id": 31,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "vertical",
            "reduceOptions": {
              "calcs": [
                "mean"
              ],
              "fields": "",
              "values": false
            },
            "text": {},
            "textMode": "value_and_name"
          },
          "pluginVersion": "10.0.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "histogram_quantile(0.50, sum by(le) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\", app=~\"$app\"}[5m])))\n",
              "hide": false,
              "legendFormat": "p50",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(0.75, sum by(le) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\", app=~\"$app\"}[5m])))",
              "hide": false,
              "legendFormat": "p75",
              "range": true,
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(0.90, sum by(le) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\", app=~\"$app\"}[5m])))",
              "hide": false,
              "legendFormat": "p90",
              "range": true,
              "refId": "C"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(.999, sum by(le) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\", app=~\"$app\"}[5m])))",
              "hide": false,
              "legendFormat": "p99.9",
              "range": true,
              "refId": "D"
            }
          ],
          "title": "Dataplane Latency ( $app )",
          "transparent": true,
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 0,
            "y": 14
          },
          "id": 33,
          "options": {
            "legend": {
              "calcs": [
                "last"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Mean",
              "sortDesc": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "9.4.7",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(0.50, sum by(le,app,namespace) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\"}[5m])))\n",
              "hide": false,
              "legendFormat": "{{namespace}} : {{app}}",
              "range": true,
              "refId": "A"
            }
          ],
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "continuous-GrYlRd"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "min": 0,
              "noValue": "0",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 6,
            "y": 14
          },
          "id": 32,
          "options": {
            "legend": {
              "calcs": [
                "last"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Mean",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "9.4.7",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(0.75, sum by(le,app,namespace) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\"}[5m])))\n",
              "hide": false,
              "legendFormat": "{{namespace}} : {{app}}",
              "range": true,
              "refId": "A"
            }
          ],
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "continuous-GrYlRd"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "min": 0,
              "noValue": "0",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 12,
            "y": 14
          },
          "id": 50,
          "options": {
            "legend": {
              "calcs": [
                "last"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Mean",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "9.4.7",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(0.90, sum by(le,app,namespace) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\"}[5m])))\n",
              "hide": false,
              "legendFormat": "{{namespace}} : {{app}}",
              "range": true,
              "refId": "A"
            }
          ],
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 18,
            "y": 14
          },
          "id": 29,
          "options": {
            "legend": {
              "calcs": [
                "last"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Mean",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "9.4.7",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(0.999, sum by(le, app, namespace) (rate(envoy_cluster_upstream_rq_time_bucket{namespace=~\"$namespace\"}[5m])))\n",
              "hide": false,
              "legendFormat": "{{namespace}} : {{app}}",
              "range": true,
              "refId": "A"
            }
          ],
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 0,
            "y": 22
          },
          "id": 47,
          "options": {
            "legend": {
              "calcs": [
                "sum"
              ],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "sortBy": "Total",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum by(app, envoy_response_code_class) (increase(envoy_http_downstream_rq_xx{envoy_http_conn_manager_prefix=\"public_listener\", namespace=~\"$namespace\", app=~\"$app\"}[5m]))",
              "legendFormat": "{{app}}-{{envoy_response_code_class}}xx",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "HTTP Status ( $app )",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 6,
            "y": 22
          },
          "id": 63,
          "options": {
            "legend": {
              "calcs": [
                "max",
                "mean",
                "lastNotNull"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Last *",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(envoy_cluster_upstream_rq_active{}) by (namespace,consul_source_service,envoy_cluster_name)",
              "legendFormat": "{{namespace}} : {{consul_source_service}} : {{envoy_cluster_name}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Requests Active (Upstream)",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 12,
            "y": 22
          },
          "id": 61,
          "options": {
            "legend": {
              "calcs": [
                "max",
                "mean",
                "lastNotNull"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "rate(envoy_listener_downstream_cx_overload_reject{}[$__interval])",
              "hide": false,
              "instant": false,
              "interval": "3m",
              "legendFormat": "{{namespace}} : {{consul_source_service}}-{{envoy_listener_address}}-overload",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "rate(envoy_listener_downstream_global_cx_overflow{}[$__interval])",
              "hide": false,
              "interval": "3m",
              "legendFormat": "{{namespace}} : {{consul_source_service}}-{{envoy_listener_address}}-overflow",
              "range": true,
              "refId": "B"
            }
          ],
          "title": "Connections Rejected",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 6,
            "x": 18,
            "y": 22
          },
          "id": 57,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Mean",
              "sortDesc": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "9.4.7",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_cluster_upstream_rq_time_count{namespace=~\"$namespace\",envoy_cluster_name!~\"prometheus_backend|local_app\"}[5m])) - on() sum(rate(envoy_cluster_upstream_rq_time_bucket{le=\"1\",envoy_cluster_name!~\"prometheus_backend|local_app\",namespace=~\"$namespace\"}[5m]))",
              "hide": false,
              "legendFormat": "<1ms",
              "range": true,
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_cluster_upstream_rq_time_count{namespace=~\"$namespace\",envoy_cluster_name!~\"prometheus_backend|local_app\"}[5m])) - on() sum(rate(envoy_cluster_upstream_rq_time_bucket{le=\"5\",envoy_cluster_name!~\"prometheus_backend|local_app\",namespace=~\"$namespace\"}[5m]))\n",
              "hide": false,
              "legendFormat": "<5ms",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_cluster_upstream_rq_time_count{namespace=~\"$namespace\",envoy_cluster_name!~\"prometheus_backend|local_app\"}[5m])) - on() sum(rate(envoy_cluster_upstream_rq_time_bucket{le=\"10\",envoy_cluster_name!~\"prometheus_backend|local_app\",namespace=~\"$namespace\"}[5m]))",
              "hide": false,
              "legendFormat": "<10ms",
              "range": true,
              "refId": "D"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_cluster_upstream_rq_time_count{namespace=~\"$namespace\",envoy_cluster_name!~\"prometheus_backend|local_app\"}[5m])) - on() sum(rate(envoy_cluster_upstream_rq_time_bucket{le=\"25\",envoy_cluster_name!~\"prometheus_backend|local_app\",namespace=~\"$namespace\"}[5m]))",
              "hide": false,
              "legendFormat": "<25ms",
              "range": true,
              "refId": "C"
            }
          ],
          "title": "$app - Latency by Throughput",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "BANDWIDTH",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "bytes"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 24,
            "x": 0,
            "y": 30
          },
          "id": 12,
          "options": {
            "legend": {
              "calcs": [
                "last",
                "sum"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Last",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "asc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "rate(container_network_receive_bytes_total{namespace=\"$namespace\", pod=~\"$app.*\"}[5m])",
              "legendFormat": "{{pod}}-rx",
              "range": true,
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "- rate(container_network_transmit_bytes_total{namespace=\"$namespace\", pod=~\"$app.*\"}[5m])",
              "hide": false,
              "legendFormat": "{{pod}}-tx",
              "range": true,
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "sum(rate(node_network_receive_drop_total{component=\"node-exporter\"}[5m]))",
              "hide": false,
              "instant": false,
              "interval": "",
              "legendFormat": "global-dropped-pkts",
              "range": true,
              "refId": "C"
            }
          ],
          "title": "Network Bytes Rx and Tx",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 37
          },
          "id": 22,
          "panels": [],
          "title": "Extras",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 8,
            "x": 0,
            "y": 38
          },
          "id": 39,
          "options": {
            "legend": {
              "calcs": [
                "last",
                "sum"
              ],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum by(namespace,app)(rate(envoy_cluster_upstream_rq_total{namespace=~\"$namespace\"}[5m]))",
              "legendFormat": "{{namespace}}:{{app}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Upstream Rq Total",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 8,
            "x": 8,
            "y": 38
          },
          "id": 41,
          "options": {
            "legend": {
              "calcs": [
                "last",
                "sum"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Last",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum by(namespace,app,envoy_response_code_class) (rate(envoy_cluster_upstream_rq_xx[5m]))",
              "legendFormat": "{{namespace}} : {{app}}-{{envoy_response_code_class}}xx",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Upstream Rq by Status Code",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 8,
            "x": 16,
            "y": 38
          },
          "id": 59,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "group(envoy_control_plane_connected_state{namespace=~\"$namespace\"}) by (local_cluster)",
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Envoy Config Stale",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 8,
            "x": 0,
            "y": 47
          },
          "id": 45,
          "options": {
            "legend": {
              "calcs": [
                "last",
                "sum"
              ],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "sortBy": "Last",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_http_downstream_rq_total{namespace=~\"$namespace\",envoy_http_conn_manager_prefix=\"public_listener\"}[5m])) by (app, namespace)\n",
              "legendFormat": "{{namespace}}:{{app}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Downstream Rq Total",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 8,
            "x": 8,
            "y": 47
          },
          "id": 51,
          "options": {
            "legend": {
              "calcs": [
                "last",
                "sum"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Last",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "sum(rate(envoy_http_downstream_rq_xx{envoy_http_conn_manager_prefix=\"public_listener\"}[5m])) by (namespace, app,envoy_response_code_class)\n",
              "legendFormat": "{{namespace}} : {{app}}-{{envoy_response_code_class}}xx",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Downstream Rq by Status Code",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "cps"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 9,
            "w": 8,
            "x": 16,
            "y": 47
          },
          "id": 62,
          "options": {
            "legend": {
              "calcs": [
                "max",
                "mean",
                "lastNotNull"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true,
              "sortBy": "Last *",
              "sortDesc": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "PBFA97CFB590B2093"
              },
              "editorMode": "code",
              "expr": "rate(envoy_listener_downstream_cx_total{namespace=~\"$namespace\"}[$__interval]) ",
              "interval": "3m",
              "legendFormat": "{{consul_source_datacenter}} : {{namespace}} : {{consul_source_service}} : {{envoy_listener_address}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Envoy Connections/sec",
          "type": "timeseries"
        }
      ],
      "refresh": "",
      "revision": 1,
      "schemaVersion": 38,
      "style": "dark",
      "tags": [],
      "templating": {
        "list": [
          {
            "current": {
              "selected": false,
              "text": "default",
              "value": "default"
            },
            "hide": 0,
            "includeAll": false,
            "multi": false,
            "name": "namespace",
            "options": [
              {
                "selected": true,
                "text": "default",
                "value": "default"
              },
              {
                "selected": false,
                "text": "consul",
                "value": "consul"
              }
            ],
            "query": "default, consul",
            "skipUrlSync": false,
            "type": "custom"
          },
          {
            "current": {
              "selected": true,
              "text": "nginx",
              "value": "nginx"
            },
            "datasource": {
              "type": "prometheus",
              "uid": "PBFA97CFB590B2093"
            },
            "definition": "label_values(app)",
            "hide": 0,
            "includeAll": true,
            "multi": false,
            "name": "app",
            "options": [],
            "query": {
              "query": "label_values(app)",
              "refId": "PrometheusVariableQueryEditor-VariableQuery"
            },
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "sort": 0,
            "type": "query"
          }
        ]
      },
      "time": {
        "from": "now-5m",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "",
      "title": "Data Plane Performance",
      "uid": "data-plane-performance",
      "version": 1,
      "weekStart": ""
    }
  consul-server-health.json: |
    {
      "annotations": { "list": [] },
      "description": "Consul server health  Raft, gossip, RPC, KV, and runtime metrics from the Datadog key metrics guide",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "id": 100,
          "title": "Raft  Leadership",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "Number of times a server became Raft leader. Should be 0 in steady state; spikes indicate instability.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 3 }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
          "id": 1,
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Leader Elections (rate)",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "increase(consul_raft_state_leader{job=\"consul\"}[5m])", "legendFormat": "elections", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "1 = has leader, 0 = no leader. Should always be 1.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "mappings": [{ "options": { "0": { "color": "red", "index": 0, "text": "NO LEADER" }, "1": { "color": "green", "index": 1, "text": "Leader OK" } }, "type": "value" }], "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "green", "value": 1 }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
          "id": 2,
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Leader Present",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_leader{job=\"consul\"}", "legendFormat": "leader", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.raft.leader.lastContact  how long (ms) for a leader to contact followers during lease check. Alert if P99 > 200ms.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "axisBorderShow": false, "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": true }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 100 }, { "color": "red", "value": 200 }] }, "unit": "ms" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 16, "x": 8, "y": 1 },
          "id": 3,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Raft Leader Last Contact (ms)",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_leader_lastContact{job=\"consul\",quantile=\"0.5\"}", "legendFormat": "P50", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_leader_lastContact{job=\"consul\",quantile=\"0.9\"}", "legendFormat": "P90", "refId": "B" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_leader_lastContact{job=\"consul\",quantile=\"0.99\"}", "legendFormat": "P99", "refId": "C" }
          ]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.raft.state.candidate  increments when a node starts a leader election.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 3, "w": 4, "x": 0, "y": 5 },
          "id": 4,
          "options": { "colorMode": "background", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Candidate Elections (5m)",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "increase(consul_raft_state_candidate{job=\"consul\"}[5m])", "legendFormat": "candidates", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "Number of peers in the Raft cluster (should match server count: typically 3 or 5).",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "green", "value": 1 }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 3, "w": 4, "x": 4, "y": 5 },
          "id": 5,
          "options": { "colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Raft Peers",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_peers{job=\"consul\"}", "legendFormat": "peers", "refId": "A" }]
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 8 },
          "id": 101,
          "title": "Raft  Commit Performance",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.raft.apply  rate of Raft log replication initiations by the leader.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "ops" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 0, "y": 9 },
          "id": 6,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Raft Apply Rate (ops/s)",
          "type": "timeseries",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_raft_apply{job=\"consul\"}[1m])", "legendFormat": "apply/s", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.raft.commitTime  time (ms) for a single Raft commit. P99 > 500ms indicates disk or network bottleneck.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "ms" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 8, "y": 9 },
          "id": 7,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Raft Commit Time (ms)",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_commitTime{job=\"consul\",quantile=\"0.5\"}", "legendFormat": "P50", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_commitTime{job=\"consul\",quantile=\"0.99\"}", "legendFormat": "P99", "refId": "B" }
          ]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.raft.leader.dispatchLog  time (ms) for a Raft leader to write a log to disk.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "ms" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 16, "y": 9 },
          "id": 8,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Leader Dispatch Log Latency (ms)",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_leader_dispatchLog{job=\"consul\",quantile=\"0.5\"}", "legendFormat": "P50", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_leader_dispatchLog{job=\"consul\",quantile=\"0.99\"}", "legendFormat": "P99", "refId": "B" }
          ]
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 16 },
          "id": 102,
          "title": "Gossip  Cluster Membership",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.serf.member.flap  node marked failed then healthy within 60s. Any value > 0 warrants investigation.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 17 },
          "id": 9,
          "options": { "colorMode": "background", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Member Flaps (5m)",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "increase(consul_serf_member_flap{job=\"consul\"}[5m])", "legendFormat": "flaps", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "Number of registered services in the Consul catalog.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 17 },
          "id": 10,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Registered Services",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_catalog_services{job=\"consul\"}", "legendFormat": "services", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.serf.member.flap over time  shows flapping patterns.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 16, "x": 8, "y": 17 },
          "id": 11,
          "options": { "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Member Flaps Over Time",
          "type": "timeseries",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "increase(consul_serf_member_flap{job=\"consul\"}[1m])", "legendFormat": "flaps/min", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.leader.reconcile  reconciliation events between leader catalog and memberlist.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 5 }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 3, "w": 4, "x": 0, "y": 21 },
          "id": 12,
          "options": { "colorMode": "background", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["sum"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Leader Reconcile Events (5m)",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "increase(consul_leader_reconcile{job=\"consul\"}[5m])", "legendFormat": "reconcile", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.memberlist.health.score  0 is perfectly healthy. Higher scores indicate degraded gossip health.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "thresholds" }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 3 }] }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 3, "w": 4, "x": 4, "y": 21 },
          "id": 13,
          "options": { "colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
          "title": "Memberlist Health Score",
          "type": "stat",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_memberlist_health_score{job=\"consul\"}", "legendFormat": "health score", "refId": "A" }]
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 24 },
          "id": 103,
          "title": "RPC  Server Communication",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.rpc.request and consul.rpc.query  incoming RPC throughput on the server.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "reqps" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 0, "y": 25 },
          "id": 14,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "RPC Request Rate",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_rpc_request{job=\"consul\"}[1m])", "legendFormat": "one-off RPCs/s", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_rpc_query{job=\"consul\"}[1m])", "legendFormat": "blocking RPCs/s", "refId": "B" }
          ]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.rpc.request_error  RPC errors on the server. Any sustained rate > 0 is a problem.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 20, "lineWidth": 2, "showPoints": "never", "spanNulls": true }, "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] }, "unit": "reqps" },
            "overrides": [{ "matcher": { "id": "byName", "options": "errors/s" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }]
          },
          "gridPos": { "h": 7, "w": 8, "x": 8, "y": 25 },
          "id": 15,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "RPC Errors",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_rpc_request_error{job=\"consul\"}[1m])", "legendFormat": "server errors/s", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_client_rpc_failed{job=\"consul\"}[1m])", "legendFormat": "client errors/s", "refId": "B" }
          ]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.client.rpc / consul.client.rpc.failed / consul.client.rpc.exceeded  client-side RPC health.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "reqps" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 16, "y": 25 },
          "id": 16,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Client RPC Health",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_client_rpc{job=\"consul\"}[1m])", "legendFormat": "RPCs/s", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_client_rpc_exceeded{job=\"consul\"}[1m])", "legendFormat": "rate-limited/s", "refId": "B" }
          ]
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 32 },
          "id": 104,
          "title": "KV Store",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.kvs.apply  time (ms) to update and replicate the KV store via Raft.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "ms" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 33 },
          "id": 17,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "KV Apply Latency (ms)",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_kvs_apply{job=\"consul\",quantile=\"0.5\"}", "legendFormat": "P50", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_kvs_apply{job=\"consul\",quantile=\"0.99\"}", "legendFormat": "P99", "refId": "B" }
          ]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.kvs.apply count  rate of KV store updates.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "ops" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 12, "x": 12, "y": 33 },
          "id": 18,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "KV Write Rate (ops/s)",
          "type": "timeseries",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(consul_kvs_apply_count{job=\"consul\"}[1m])", "legendFormat": "writes/s", "refId": "A" }]
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 40 },
          "id": 105,
          "title": "Runtime  Memory & GC",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.runtime.alloc_bytes  heap memory currently in use by Consul. Sudden spikes indicate catalog growth or memory leaks.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "bytes" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 0, "y": 41 },
          "id": 19,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Heap Allocated (bytes)",
          "type": "timeseries",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_runtime_alloc_bytes{job=\"consul\"}", "legendFormat": "alloc_bytes", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.runtime.sys_bytes  total virtual address space reserved by the Go runtime.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "bytes" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 8, "y": 41 },
          "id": 20,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Virtual Memory (sys_bytes)",
          "type": "timeseries",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_runtime_sys_bytes{job=\"consul\"}", "legendFormat": "sys_bytes", "refId": "A" }]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.runtime.gc_pause_ns  GC pause duration. Long pauses can cause leader heartbeat timeouts.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "ns" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 8, "x": 16, "y": 41 },
          "id": 21,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "GC Pause Duration (ns)",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_runtime_gc_pause_ns{job=\"consul\",quantile=\"0.5\"}", "legendFormat": "P50", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_runtime_gc_pause_ns{job=\"consul\",quantile=\"0.99\"}", "legendFormat": "P99", "refId": "B" }
          ]
        },
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 48 },
          "id": 106,
          "title": "Raft  Replication",
          "type": "row"
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.raft.rpc.appendEntries  time (ms) for a follower to process replicated log entries from the leader.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "line", "fillOpacity": 10, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "ms" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 12, "x": 0, "y": 49 },
          "id": 22,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Append Entries Latency (ms)  Follower",
          "type": "timeseries",
          "targets": [
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_rpc_appendEntries{job=\"consul\",quantile=\"0.5\"}", "legendFormat": "P50", "refId": "A" },
            { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "consul_raft_rpc_appendEntries{job=\"consul\",quantile=\"0.99\"}", "legendFormat": "P99", "refId": "B" }
          ]
        },
        {
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "description": "consul.raft.snapshot.create  number of snapshots Consul has created. Frequent snapshots indicate high churn.",
          "fieldConfig": {
            "defaults": { "color": { "mode": "palette-classic" }, "custom": { "drawStyle": "bars", "fillOpacity": 80, "lineWidth": 1, "showPoints": "never", "spanNulls": true }, "unit": "short" },
            "overrides": []
          },
          "gridPos": { "h": 7, "w": 12, "x": 12, "y": 49 },
          "id": 23,
          "options": { "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom" }, "tooltip": { "mode": "multi" } },
          "title": "Raft Snapshots Created",
          "type": "timeseries",
          "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "increase(consul_raft_snapshot_create{job=\"consul\"}[5m])", "legendFormat": "snapshots/5m", "refId": "A" }]
        }
      ],
      "refresh": "30s",
      "schemaVersion": 38,
      "tags": ["consul", "raft", "gossip", "rpc", "kv", "server-health"],
      "templating": { "list": [] },
      "time": { "from": "now-30m", "to": "now" },
      "timepicker": {},
      "timezone": "browser",
      "title": "Consul Server Health",
      "uid": "consul-server-health",
      "version": 1,
      "weekStart": ""
    }

  service-traceability.json: |
    {
        "__inputs": [
            {
                "name": "DS_PROMETHEUS",
                "label": "Prometheus",
                "description": "",
                "type": "datasource",
                "pluginId": "prometheus",
                "pluginName": "Prometheus"
            },
            {
                "name": "DS_JAEGER",
                "label": "Jaeger",
                "description": "",
                "type": "datasource",
                "pluginId": "jaeger",
                "pluginName": "Jaeger"
            }
        ],
        "__elements": {},
        "__requires": [
            {
                "type": "panel",
                "id": "bargauge",
                "name": "Bar gauge",
                "version": ""
            },
            {
                "type": "panel",
                "id": "traces",
                "name": "Traces",
                "version": ""
            },
            {
                "type": "grafana",
                "id": "grafana",
                "name": "Grafana",
                "version": "11.1.0"
            },
            {
                "type": "datasource",
                "id": "prometheus",
                "name": "Prometheus",
                "version": "1.0.0"
            },
            {
                "type": "datasource",
                "id": "jaeger",
                "name": "Jaeger",
                "version": "1.0.0"
            },
            {
                "type": "panel",
                "id": "timeseries",
                "name": "Time series",
                "version": ""
            }
        ],
        "annotations": {
            "list": [
                {
                    "builtIn": 1,
                    "datasource": {
                        "type": "grafana",
                        "uid": "-- Grafana --"
                    },
                    "enable": true,
                    "hide": true,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "type": "dashboard"
                }
            ]
        },
        "editable": true,
        "fiscalYearStartMonth": 0,
        "graphTooltip": 0,
        "id": null,
        "links": [],
        "panels": [
            {
                "collapsed": false,
                "gridPos": {
                    "h": 1,
                    "w": 24,
                    "x": 0,
                    "y": 0
                },
                "id": 5,
                "panels": [],
                "title": "Service Health \u2014 $source_service \u2192 $destination_service",
                "type": "row"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "${DS_PROMETHEUS}"
                },
                "description": "5xx error rate between service pairs. Only shows pairs with >1% error rate.",
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "palette-classic"
                        },
                        "custom": {
                            "axisBorderShow": false,
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "opacity",
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 1,
                            "scaleDistribution": {
                                "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": false,
                            "stacking": {
                                "group": "A",
                                "mode": "none"
                            },
                            "thresholdsStyle": {
                                "mode": "line"
                            }
                        },
                        "fieldMinMax": false,
                        "mappings": [],
                        "noValue": "0",
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "yellow",
                                    "value": 1
                                },
                                {
                                    "color": "red",
                                    "value": 5
                                }
                            ]
                        },
                        "unit": "percent",
                        "links": [
                            {
                                "title": "View traces in Jaeger",
                                "url": "/explore?orgId=1&left={\"datasource\":\"jaeger\",\"queries\":[{\"refId\":\"A\",\"queryType\":\"search\",\"service\":\"${__series.labels.local_cluster}\",\"limit\":20}],\"range\":{\"from\":\"${__from}\",\"to\":\"${__to}\"}}",
                                "targetBlank": true
                            }
                        ]
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 8,
                    "w": 12,
                    "x": 0,
                    "y": 1
                },
                "id": 1,
                "options": {
                    "legend": {
                        "calcs": [],
                        "displayMode": "list",
                        "placement": "right",
                        "showLegend": true
                    },
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "${DS_PROMETHEUS}"
                        },
                        "editorMode": "code",
                        "expr": "(\n  sum(irate(envoy_cluster_upstream_rq_xx{envoy_response_code_class=\"5\", consul_destination_service!=\"\", consul_source_service=~\"$source_service\", consul_destination_service=~\"$destination_service\"}[5m]))\n  by (local_cluster, consul_destination_service)\n  /\n  sum(irate(envoy_cluster_upstream_rq_xx{consul_destination_service!=\"\", consul_source_service=~\"$source_service\", consul_destination_service=~\"$destination_service\"}[5m]))\n  by (local_cluster, consul_destination_service)\n) * 100 > 0.1",
                        "instant": false,
                        "legendFormat": "{{local_cluster}} \u2192 {{consul_destination_service}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "5xx Error Rate",
                "transparent": true,
                "type": "timeseries"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "${DS_PROMETHEUS}"
                },
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "palette-classic"
                        },
                        "custom": {
                            "axisBorderShow": false,
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "opacity",
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 1,
                            "scaleDistribution": {
                                "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": false,
                            "stacking": {
                                "group": "A",
                                "mode": "none"
                            },
                            "thresholdsStyle": {
                                "mode": "off"
                            }
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "red",
                                    "value": 80
                                }
                            ]
                        },
                        "unit": "ms",
                        "links": [
                            {
                                "title": "View traces in Jaeger",
                                "url": "/explore?orgId=1&left={\"datasource\":\"jaeger\",\"queries\":[{\"refId\":\"A\",\"queryType\":\"search\",\"service\":\"${__series.labels.local_cluster}\",\"limit\":20}],\"range\":{\"from\":\"${__from}\",\"to\":\"${__to}\"}}",
                                "targetBlank": true
                            }
                        ]
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 8,
                    "w": 12,
                    "x": 12,
                    "y": 1
                },
                "id": 2,
                "options": {
                    "legend": {
                        "calcs": [],
                        "displayMode": "list",
                        "placement": "right",
                        "showLegend": true
                    },
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "${DS_PROMETHEUS}"
                        },
                        "editorMode": "code",
                        "expr": "histogram_quantile(0.99,\n  sum(rate(envoy_cluster_upstream_rq_time_bucket{\n    consul_destination_service!=\"\",\n    consul_source_service=~\"$source_service\",\n    consul_destination_service=~\"$destination_service\"\n  }[5m]))\n  by (le, local_cluster, consul_destination_service)\n)",
                        "instant": false,
                        "legendFormat": "{{local_cluster}} \u2192 {{consul_destination_service}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "P99 Latency",
                "transparent": true,
                "type": "timeseries"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "${DS_PROMETHEUS}"
                },
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "palette-classic"
                        },
                        "custom": {
                            "axisBorderShow": false,
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "opacity",
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 1,
                            "scaleDistribution": {
                                "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": false,
                            "stacking": {
                                "group": "A",
                                "mode": "none"
                            },
                            "thresholdsStyle": {
                                "mode": "off"
                            }
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "red",
                                    "value": 80
                                }
                            ]
                        },
                        "links": [
                            {
                                "title": "View traces in Jaeger",
                                "url": "/explore?orgId=1&left={\"datasource\":\"jaeger\",\"queries\":[{\"refId\":\"A\",\"queryType\":\"search\",\"service\":\"${__series.labels.local_cluster}\",\"limit\":20}],\"range\":{\"from\":\"${__from}\",\"to\":\"${__to}\"}}",
                                "targetBlank": true
                            }
                        ]
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 8,
                    "w": 12,
                    "x": 0,
                    "y": 9
                },
                "id": 3,
                "options": {
                    "legend": {
                        "calcs": [],
                        "displayMode": "list",
                        "placement": "right",
                        "showLegend": true
                    },
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "${DS_PROMETHEUS}"
                        },
                        "editorMode": "code",
                        "expr": "sum(\n  irate(envoy_cluster_upstream_rq_total{\n    consul_destination_service!=\"\",\n    consul_source_service=~\"$source_service\",\n    consul_destination_service=~\"$destination_service\",\n    local_cluster!=\"mesh-gateway\"\n  }[5m])\n) by (local_cluster, consul_destination_service)",
                        "instant": false,
                        "legendFormat": "{{local_cluster}} \u2192 {{consul_destination_service}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "Request Volume (RPS)",
                "transparent": true,
                "type": "timeseries"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "${DS_PROMETHEUS}"
                },
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "palette-classic"
                        },
                        "custom": {
                            "axisBorderShow": false,
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "opacity",
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 1,
                            "scaleDistribution": {
                                "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": false,
                            "stacking": {
                                "group": "A",
                                "mode": "none"
                            },
                            "thresholdsStyle": {
                                "mode": "off"
                            }
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "red",
                                    "value": 80
                                }
                            ]
                        }
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 8,
                    "w": 12,
                    "x": 12,
                    "y": 9
                },
                "id": 4,
                "options": {
                    "legend": {
                        "calcs": [],
                        "displayMode": "list",
                        "placement": "right",
                        "showLegend": true
                    },
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "${DS_PROMETHEUS}"
                        },
                        "editorMode": "code",
                        "expr": "sum(\n  envoy_cluster_upstream_cx_active{\n    consul_destination_service!=\"\",\n    consul_source_service=~\"$source_service\",\n    consul_destination_service=~\"$destination_service\",\n    local_cluster!=\"mesh-gateway\"\n  }\n) by (local_cluster, consul_destination_service)",
                        "instant": false,
                        "legendFormat": "{{local_cluster}} \u2192 {{consul_destination_service}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "Active Upstream Connections",
                "transparent": true,
                "type": "timeseries"
            },
            {
                "collapsed": false,
                "gridPos": {
                    "h": 1,
                    "w": 24,
                    "x": 0,
                    "y": 17
                },
                "id": 6,
                "panels": [],
                "title": "Circuit Breaker",
                "type": "row"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "${DS_PROMETHEUS}"
                },
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "palette-classic"
                        },
                        "custom": {
                            "axisBorderShow": false,
                            "axisCenteredZero": false,
                            "axisColorMode": "text",
                            "axisLabel": "",
                            "axisPlacement": "auto",
                            "barAlignment": 0,
                            "drawStyle": "line",
                            "fillOpacity": 10,
                            "gradientMode": "opacity",
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineInterpolation": "linear",
                            "lineWidth": 2,
                            "pointSize": 1,
                            "scaleDistribution": {
                                "type": "linear"
                            },
                            "showPoints": "auto",
                            "spanNulls": false,
                            "stacking": {
                                "group": "A",
                                "mode": "none"
                            },
                            "thresholdsStyle": {
                                "mode": "off"
                            }
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "red",
                                    "value": 80
                                }
                            ]
                        }
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 8,
                    "w": 12,
                    "x": 0,
                    "y": 18
                },
                "id": 7,
                "options": {
                    "legend": {
                        "calcs": [],
                        "displayMode": "list",
                        "placement": "right",
                        "showLegend": true
                    },
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "${DS_PROMETHEUS}"
                        },
                        "editorMode": "code",
                        "expr": "sum(\n  envoy_cluster_outlier_detection_ejections_active{\n    consul_destination_service!=\"\",\n    consul_source_service=~\"$source_service\",\n    consul_destination_service=~\"$destination_service\",\n    local_cluster!=\"mesh-gateway\"\n  }\n) by (local_cluster, consul_destination_service)",
                        "instant": false,
                        "legendFormat": "{{local_cluster}} \u2192 {{consul_destination_service}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "Active Circuit Breakers",
                "transparent": true,
                "type": "timeseries"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "${DS_PROMETHEUS}"
                },
                "description": "Number of times a host was ejected for consecutive 5xx errors within the selected time range.",
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "thresholds"
                        },
                        "decimals": 0,
                        "mappings": [],
                        "min": 0,
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "#EAB839",
                                    "value": 1
                                },
                                {
                                    "color": "red",
                                    "value": 5
                                }
                            ]
                        }
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 8,
                    "w": 12,
                    "x": 12,
                    "y": 18
                },
                "id": 8,
                "options": {
                    "displayMode": "basic",
                    "maxVizHeight": 50,
                    "minVizHeight": 16,
                    "minVizWidth": 8,
                    "namePlacement": "auto",
                    "orientation": "horizontal",
                    "reduceOptions": {
                        "calcs": [
                            "last"
                        ],
                        "fields": "",
                        "values": false
                    },
                    "showUnfilled": true,
                    "sizing": "manual",
                    "valueMode": "color"
                },
                "pluginVersion": "11.1.0",
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "${DS_PROMETHEUS}"
                        },
                        "editorMode": "code",
                        "expr": "sum(\n  increase(envoy_cluster_outlier_detection_ejections_consecutive_5xx{\n    consul_destination_service!=\"\",\n    consul_source_service=~\"$source_service\",\n    consul_destination_service=~\"$destination_service\",\n    local_cluster!=\"mesh-gateway\"\n  }[$__range])\n) by (consul_destination_service)",
                        "instant": false,
                        "legendFormat": "{{consul_destination_service}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "Circuit Breakers Triggered",
                "transformations": [
                    {
                        "id": "sortBy",
                        "options": {
                            "fields": {},
                            "sort": [
                                {
                                    "desc": true
                                }
                            ]
                        }
                    }
                ],
                "transparent": true,
                "type": "bargauge"
            },
            {
                "collapsed": false,
                "gridPos": {
                    "h": 1,
                    "w": 24,
                    "x": 0,
                    "y": 26
                },
                "id": 9,
                "panels": [],
                "title": "Distributed Traces \u2014 Jaeger",
                "type": "row"
            },
            {
                "datasource": {
                    "type": "jaeger",
                    "uid": "${DS_JAEGER}"
                },
                "description": "Live traces from the selected source service. Click any trace to open in Jaeger.",
                "gridPos": {
                    "h": 14,
                    "w": 12,
                    "x": 0,
                    "y": 27
                },
                "id": 10,
                "options": {
                    "dedupStrategy": "none",
                    "enableLogDetails": true,
                    "prettifyLogMessage": false,
                    "showLabels": false,
                    "showTime": false,
                    "sortOrder": "Descending",
                    "wrapLogMessage": false
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "jaeger",
                            "uid": "${DS_JAEGER}"
                        },
                        "queryType": "search",
                        "refId": "A",
                        "service": "$source_service",
                        "limit": 20
                    }
                ],
                "title": "Recent Traces \u2014 $source_service",
                "transparent": true,
                "type": "traces"
            },
            {
                "datasource": {
                    "type": "jaeger",
                    "uid": "${DS_JAEGER}"
                },
                "description": "Live traces from the selected destination service. Click any trace to open in Jaeger.",
                "gridPos": {
                    "h": 14,
                    "w": 12,
                    "x": 12,
                    "y": 27
                },
                "id": 11,
                "options": {
                    "dedupStrategy": "none",
                    "enableLogDetails": true,
                    "prettifyLogMessage": false,
                    "showLabels": false,
                    "showTime": false,
                    "sortOrder": "Descending",
                    "wrapLogMessage": false
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "jaeger",
                            "uid": "${DS_JAEGER}"
                        },
                        "queryType": "search",
                        "refId": "A",
                        "service": "$destination_service",
                        "limit": 20
                    }
                ],
                "title": "Recent Traces \u2014 $destination_service",
                "transparent": true,
                "type": "traces"
            }
        ],
        "refresh": "10s",
        "schemaVersion": 39,
        "tags": [
            "consul",
            "envoy",
            "jaeger",
            "tracing"
        ],
        "templating": {
            "list": [
                {
                    "current": {},
                    "datasource": {
                        "type": "prometheus",
                        "uid": "${DS_PROMETHEUS}"
                    },
                    "definition": "label_values(envoy_cluster_upstream_rq_total{consul_destination_service!=\"\"}, consul_source_service)",
                    "hide": 0,
                    "includeAll": true,
                    "multi": false,
                    "name": "source_service",
                    "options": [],
                    "query": {
                        "qryType": 1,
                        "query": "label_values(envoy_cluster_upstream_rq_total{consul_destination_service!=\"\"}, consul_source_service)",
                        "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 2,
                    "regex": "",
                    "skipUrlSync": false,
                    "sort": 1,
                    "type": "query"
                },
                {
                    "current": {},
                    "datasource": {
                        "type": "prometheus",
                        "uid": "${DS_PROMETHEUS}"
                    },
                    "definition": "label_values(envoy_cluster_upstream_rq_total{consul_destination_service!=\"\"}, consul_destination_service)",
                    "hide": 0,
                    "includeAll": true,
                    "multi": true,
                    "name": "destination_service",
                    "options": [],
                    "query": {
                        "qryType": 1,
                        "query": "label_values(envoy_cluster_upstream_rq_total{consul_destination_service!=\"\"}, consul_destination_service)",
                        "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 2,
                    "regex": "",
                    "skipUrlSync": false,
                    "sort": 1,
                    "type": "query"
                }
            ]
        },
        "time": {
            "from": "now-15m",
            "to": "now"
        },
        "timepicker": {},
        "timezone": "browser",
        "title": "Service Traceability",
        "uid": "consul-service-traceability",
        "version": 1,
        "weekStart": ""
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: observability
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        uid: prometheus
        url: http://prometheus.observability.svc.cluster.local:9090
        access: proxy
        isDefault: true
        editable: false
        jsonData:
          httpMethod: POST
          timeInterval: "15s"

      - name: Loki
        type: loki
        uid: loki
        url: http://loki.observability.svc.cluster.local:3100
        access: proxy
        editable: false
        jsonData:
          maxLines: 1000
          derivedFields:
            - name: TraceID
              matcherRegex: '"traceparent":"00-([0-9a-f]{32})-'
              url: "$${__value.raw}"
              datasourceUid: jaeger

      - name: Jaeger
        type: jaeger
        uid: jaeger
        url: http://jaeger-query.observability.svc.cluster.local:16686
        access: proxy
        editable: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: observability
data:
  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: consul-observability
        folder: Consul Observability
        type: file
        disableDeletion: true
        updateIntervalSeconds: 30
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: observability
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
      annotations:
        consul.hashicorp.com/connect-inject: "false"
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:10.4.3
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: admin
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-secret
                  key: password
                  optional: true  # falls back to GF_SECURITY_ADMIN_PASSWORD default
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: admin        # override in production via secret
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "false"
            - name: GF_EXPLORE_ENABLED
              value: "true"
          ports:
            - containerPort: 3000
              name: http
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboard-provider
              mountPath: /etc/grafana/provisioning/dashboards
            - name: dashboards
              mountPath: /var/lib/grafana/dashboards
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
      volumes:
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboard-provider
          configMap:
            name: grafana-dashboard-provider
        - name: dashboards
          configMap:
            name: grafana-dashboards
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: observability
  labels:
    app: grafana
spec:
  selector:
    app: grafana
  ports:
    - name: http
      port: 3000
      targetPort: 3000
  type: ClusterIP
