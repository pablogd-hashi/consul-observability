# kubernetes/observability/grafana.yaml
# Grafana with pre-provisioned datasources and 5 observability dashboards:
#   service-health.json        — error rate, latency, volume, circuit breakers
#   consul-health.json         — Consul cluster health (Consul 1.22+ metrics)
#   service-to-service.json    — service-to-service traffic (Envoy metrics)
#   logs.json                  — Envoy access logs via Promtail -> Loki
#   gateways.json              — API Gateway + Terminating Gateway metrics
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: observability
data:
  service-health.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 5,
          "panels": [],
          "title": "Services Health",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "fieldMinMax": false,
              "mappings": [],
              "noValue": "0",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 1
          },
          "id": 1,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "editorMode": "code",
              "expr": "(\n  1 - (\n    sum(irate(envoy_cluster_upstream_rq_xx{envoy_response_code_class!=\"5\", consul_destination_service!=\"\"}[5m])) \n    by (local_cluster, consul_destination_service) \n    / \n    sum(irate(envoy_cluster_upstream_rq_xx{consul_destination_service!=\"\"}[5m])) \n    by (local_cluster, consul_destination_service)\n  )\n) * 100 > 1",
              "instant": false,
              "legendFormat": "{{local_cluster}} -> {{consul_destination_service}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Services with High Error Rate ",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 1
          },
          "id": 2,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "editorMode": "code",
              "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket{consul_destination_service!~\"\"}[5m])) by (le,local_cluster, consul_destination_service))",
              "instant": false,
              "legendFormat": "{{local_cluster}} -> {{consul_destination_service}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "P95 Latency",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 9
          },
          "id": 3,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "editorMode": "code",
              "expr": "sum(irate(envoy_cluster_upstream_rq_total{consul_destination_service!=\"\", consul_source_service!=\"mesh-gateway\"}[5m])) by (local_cluster, consul_destination_service) ",
              "instant": false,
              "legendFormat": "{{local_cluster}} -> {{consul_destination_service}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Request Volume",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 9
          },
          "id": 4,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "editorMode": "code",
              "expr": "sum(envoy_cluster_upstream_cx_active{consul_destination_service!=\"\", consul_source_service!=\"mesh-gateway\"}) by (local_cluster, consul_destination_service)",
              "instant": false,
              "legendFormat": "{{local_cluster}} -> {{consul_destination_service}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Upstream Connections",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 17
          },
          "id": 6,
          "panels": [],
          "title": "Circuit Breaker",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 80
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 18
          },
          "id": 7,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "editorMode": "code",
              "expr": "sum (envoy_cluster_outlier_detection_ejections_active{consul_destination_service!~\"\", local_cluster!=\"mesh-gateway\"}) by (local_cluster, consul_destination_service)",
              "instant": false,
              "legendFormat": "{{local_cluster}} -> {{consul_destination_service}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Active Circuit Breakers",
          "transparent": true,
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 0,
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "#EAB839",
                    "value": 1
                  },
                  {
                    "color": "red",
                    "value": 5
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 18
          },
          "id": 8,
          "options": {
            "displayMode": "basic",
            "maxVizHeight": 50,
            "minVizHeight": 16,
            "minVizWidth": 8,
            "namePlacement": "auto",
            "orientation": "horizontal",
            "reduceOptions": {
              "calcs": [
                "last"
              ],
              "fields": "",
              "values": false
            },
            "showUnfilled": true,
            "sizing": "manual",
            "valueMode": "color"
          },
          "pluginVersion": "11.1.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "editorMode": "code",
              "expr": "sum(increase(envoy_cluster_outlier_detection_ejections_consecutive_5xx{consul_destination_service!~\"\", local_cluster!=\"mesh-gateway\"}[$__range])) by (consul_destination_service)",
              "instant": false,
              "legendFormat": "{{consul_destination_service}}",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Circuit Breakers Triggered",
          "transformations": [
            {
              "id": "sortBy",
              "options": {
                "fields": {},
                "sort": [
                  {
                    "desc": true
                  }
                ]
              }
            }
          ],
          "transparent": true,
          "type": "bargauge"
        }
      ],
      "refresh": "5s",
      "schemaVersion": 39,
      "tags": [],
      "templating": {
        "list": [
          {
            "current": {},
            "datasource": {
              "type": "prometheus",
              "uid": "prometheus"
            },
            "definition": "label_values(consul_source_service)",
            "hide": 0,
            "includeAll": true,
            "multi": false,
            "name": "source_service",
            "options": [],
            "query": {
              "qryType": 1,
              "query": "label_values(consul_source_service)",
              "refId": "PrometheusVariableQueryEditor-VariableQuery"
            },
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "sort": 0,
            "type": "query"
          },
          {
            "current": {},
            "datasource": {
              "type": "prometheus",
              "uid": "prometheus"
            },
            "definition": "label_values(consul_destination_service)",
            "hide": 0,
            "includeAll": true,
            "multi": true,
            "name": "destination_service",
            "options": [],
            "query": {
              "qryType": 1,
              "query": "label_values(consul_destination_service)",
              "refId": "PrometheusVariableQueryEditor-VariableQuery"
            },
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "sort": 0,
            "type": "query"
          },
          {
            "current": {},
            "datasource": {
              "type": "prometheus",
              "uid": "prometheus"
            },
            "definition": "label_values(namespace)",
            "hide": 0,
            "includeAll": false,
            "multi": false,
            "name": "namespace",
            "options": [],
            "query": {
              "qryType": 1,
              "query": "label_values(namespace)",
              "refId": "PrometheusVariableQueryEditor-VariableQuery"
            },
            "refresh": 1,
            "regex": "/^(?!kube|monitoring).*/",
            "skipUrlSync": false,
            "sort": 0,
            "type": "query"
          }
        ]
      },
      "time": {
        "from": "now-5m",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Service Health",
      "uid": "ffbs6tb0gr4lcb",
      "version": 5,
      "weekStart": ""
    }
  consul-health.json: |
    {
      "title": "Consul Service Health",
      "uid": "consul-health",
      "description": "Consul cluster health: members, registered services, autopilot health, raft activity, and runtime metrics. Metric names reflect Consul 1.22+.",
      "tags": ["consul", "health"],
      "timezone": "browser",
      "schemaVersion": 38,
      "refresh": "30s",
      "time": { "from": "now-1h", "to": "now" },
      "templating": { "list": [] },
      "panels": [
        {
          "id": 1,
          "title": "LAN Members",
          "description": "Total active Consul gossip members (servers + clients). consul_members_servers + consul_members_clients.",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 0, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": {
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              },
              "unit": "short"
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "(consul_members_servers{datacenter=\"dc1\"} or vector(0)) + (consul_members_clients{datacenter=\"dc1\"} or vector(0))",
              "legendFormat": "Members",
              "refId": "A"
            }
          ]
        },
        {
          "id": 2,
          "title": "Service Instances",
          "description": "Number of service instances registered in the catalog (consul_state_billable_service_instances).",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 4, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": {
                "steps": [
                  { "color": "yellow", "value": null },
                  { "color": "green", "value": 1 }
                ]
              },
              "unit": "short"
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "max(consul_state_billable_service_instances) or vector(0)",
              "legendFormat": "Service Instances",
              "refId": "A"
            }
          ]
        },
        {
          "id": 3,
          "title": "Autopilot Healthy",
          "description": "Consul autopilot health (1 = healthy, 0 = degraded). Green = cluster is healthy.",
          "type": "stat",
          "gridPos": { "h": 4, "w": 4, "x": 8, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "thresholds": {
                "steps": [
                  { "color": "red", "value": null },
                  { "color": "green", "value": 1 }
                ]
              },
              "unit": "short",
              "mappings": [
                { "type": "value", "options": { "0": { "text": "DEGRADED", "color": "red" }, "1": { "text": "HEALTHY", "color": "green" } } }
              ]
            }
          },
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "reduceOptions": { "calcs": ["lastNotNull"] }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "consul_autopilot_healthy or vector(0)",
              "legendFormat": "Autopilot",
              "refId": "A"
            }
          ]
        },
        {
          "id": 4,
          "title": "Catalog API Activity",
          "description": "Rate of catalog register / deregister API calls — shows mesh churn (consul_client_api_success_catalog_*).",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "ops",
              "color": { "mode": "palette-classic" },
              "custom": { "fillOpacity": 10, "lineWidth": 1 }
            }
          },
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "rate(consul_client_api_success_catalog_register[1m])",
              "legendFormat": "register/s",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "rate(consul_client_api_success_catalog_deregister[1m])",
              "legendFormat": "deregister/s",
              "refId": "B"
            }
          ]
        },
        {
          "id": 5,
          "title": "Consul RPC Request Rate",
          "description": "Incoming RPC requests per second (consul_client_rpc counter).",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "reqps",
              "color": { "mode": "palette-classic" },
              "custom": { "fillOpacity": 10, "lineWidth": 1 }
            }
          },
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "rate(consul_client_rpc[1m])",
              "legendFormat": "RPC req/s",
              "refId": "A"
            }
          ]
        },
        {
          "id": 6,
          "title": "Raft Applied Index",
          "description": "Monotonically increasing Raft commit index. A growing index confirms the leader is processing writes.",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "color": { "mode": "palette-classic" },
              "custom": { "fillOpacity": 10, "lineWidth": 1 }
            }
          },
          "options": {
            "legend": { "calcs": ["last"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "single", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "consul_raft_applied_index",
              "legendFormat": "applied index",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "consul_raft_last_index",
              "legendFormat": "last index",
              "refId": "B"
            }
          ]
        },
        {
          "id": 7,
          "title": "Consul Runtime Memory",
          "description": "Go heap allocated and total reserved bytes from the Consul process.",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "bytes",
              "color": { "mode": "palette-classic" },
              "custom": { "fillOpacity": 10, "lineWidth": 1 }
            }
          },
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "single", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "consul_runtime_alloc_bytes",
              "legendFormat": "alloc bytes",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "consul_runtime_sys_bytes",
              "legendFormat": "sys bytes",
              "refId": "B"
            }
          ]
        },
        {
          "id": 8,
          "title": "Goroutines",
          "description": "Number of active goroutines in the Consul server process.",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 20 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "color": { "mode": "palette-classic" },
              "custom": { "fillOpacity": 10, "lineWidth": 1 }
            }
          },
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "single", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "consul_runtime_num_goroutines",
              "legendFormat": "goroutines",
              "refId": "A"
            }
          ]
        },
        {
          "id": 9,
          "title": "Registered Service Instances Over Time",
          "description": "Total service instances tracked by Consul state store (consul_state_service_instances and consul_state_billable_service_instances).",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 20 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "color": { "mode": "palette-classic" },
              "custom": { "fillOpacity": 10, "lineWidth": 1 }
            }
          },
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "single", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "max(consul_state_service_instances) or vector(0)",
              "legendFormat": "service instances",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "max(consul_state_billable_service_instances) or vector(0)",
              "legendFormat": "billable instances",
              "refId": "B"
            }
          ]
        }
      ]
    }
    
  service-to-service.json: |
    {
      "title": "Service-to-Service Traffic",
      "uid": "service-to-service",
      "description": "Entry-point metrics from Envoy and distributed traces from Jaeger. Topology: web → api → [payments, cache] → currency.",
      "tags": ["consul", "envoy", "fake-service", "mesh"],
      "timezone": "browser",
      "schemaVersion": 38,
      "refresh": "15s",
      "time": { "from": "now-30m", "to": "now" },
      "templating": { "list": [] },
      "panels": [
        {
          "id": 1,
          "title": "Request Rate (RPS)",
          "description": "Inbound requests/s through the Envoy proxy",
          "type": "stat",
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "reqps",
              "color": { "mode": "thresholds" },
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 5 },
                  { "color": "red", "value": 20 }
                ]
              }
            }
          },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background" },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "sum(rate(envoy_cluster_upstream_rq_total[1m]))",
              "legendFormat": "RPS",
              "refId": "A"
            }
          ]
        },
        {
          "id": 2,
          "title": "Error Rate (%)",
          "description": "Percentage of 5xx responses from upstream",
          "type": "stat",
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "percentunit",
              "color": { "mode": "thresholds" },
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 0.01 },
                  { "color": "red", "value": 0.05 }
                ]
              }
            }
          },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background" },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "sum(rate(envoy_cluster_upstream_rq_xx{envoy_response_code_class=\"5\"}[1m])) / sum(rate(envoy_cluster_upstream_rq_total[1m]))",
              "legendFormat": "Error %",
              "refId": "A"
            }
          ]
        },
        {
          "id": 3,
          "title": "P99 Latency (ms)",
          "description": "99th percentile upstream response time",
          "type": "stat",
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "color": { "mode": "thresholds" },
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 100 },
                  { "color": "red", "value": 500 }
                ]
              }
            }
          },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "background" },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket[1m])) by (le))",
              "legendFormat": "p99",
              "refId": "A"
            }
          ]
        },
        {
          "id": 4,
          "title": "Active Connections",
          "description": "Upstream connections currently active",
          "type": "stat",
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "color": { "mode": "thresholds" },
              "thresholds": {
                "steps": [
                  { "color": "green", "value": null },
                  { "color": "yellow", "value": 50 },
                  { "color": "red", "value": 200 }
                ]
              }
            }
          },
          "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value" },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "sum(envoy_cluster_upstream_cx_active)",
              "legendFormat": "active",
              "refId": "A"
            }
          ]
        },
        {
          "id": 5,
          "title": "Request Rate by Status Class",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": { "unit": "reqps", "color": { "mode": "palette-classic" } }
          },
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "sum by (envoy_response_code_class) (rate(envoy_cluster_upstream_rq_xx[1m]))",
              "legendFormat": "{{envoy_response_code_class}}xx",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "sum(rate(envoy_cluster_upstream_rq_total[1m]))",
              "legendFormat": "total",
              "refId": "B"
            }
          ]
        },
        {
          "id": 6,
          "title": "Response Time (P50 / P95 / P99)",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "fieldConfig": {
            "defaults": { "unit": "ms", "color": { "mode": "palette-classic" } }
          },
          "options": {
            "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom" },
            "tooltip": { "mode": "multi", "sort": "none" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "histogram_quantile(0.50, sum(rate(envoy_cluster_upstream_rq_time_bucket[1m])) by (le))",
              "legendFormat": "p50",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "histogram_quantile(0.95, sum(rate(envoy_cluster_upstream_rq_time_bucket[1m])) by (le))",
              "legendFormat": "p95",
              "refId": "B"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket[1m])) by (le))",
              "legendFormat": "p99",
              "refId": "C"
            }
          ]
        },
        {
          "id": 7,
          "title": "Distributed Traces — Service Call Chain",
          "description": "Full call chain: web → api → payments → currency + cache. Click any trace to see the waterfall.",
          "type": "traces",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 12 },
          "datasource": { "type": "jaeger", "uid": "jaeger" },
          "targets": [
            {
              "datasource": { "type": "jaeger", "uid": "jaeger" },
              "queryType": "search",
              "service": "web",
              "refId": "A"
            }
          ]
        },
        {
          "id": 8,
          "title": "Service Dependency Map",
          "description": "Live service topology derived from distributed traces via the OTel servicegraphconnector. Each arrow = active call path, labelled with req/s. Works in both Docker and K8s — all services send Zipkin traces through OTel which derives the graph. Topology: web -> api -> [payments, cache] -> currency.",
          "type": "nodeGraph",
          "gridPos": { "h": 14, "w": 24, "x": 0, "y": 22 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "options": {
            "nodes": { "mainStatUnit": "reqps" },
            "edges": { "mainStatUnit": "reqps" }
          },
          "targets": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "expr": "sum by (client, server) (rate(traces_service_graph_request_total{client!=\"\",server!=\"\"}[1m]))",
              "format": "table",
              "instant": true,
              "legendFormat": "",
              "refId": "A"
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": { "Time": true },
                "renameByName": {
                  "client": "source",
                  "server": "target",
                  "Value": "mainStat"
                }
              }
            }
          ]
        }
      ]
    }
    
  logs.json: |
    {
      "title": "Envoy Access Logs",
      "uid": "envoy-logs-k8s",
      "description": "Envoy sidecar access logs via Promtail. In K8s, Consul Connect writes access logs to stdout of the consul-dataplane container, which Promtail scrapes.",
      "tags": [
        "logs",
        "envoy",
        "loki"
      ],
      "timezone": "browser",
      "schemaVersion": 38,
      "refresh": "10s",
      "time": {
        "from": "now-30m",
        "to": "now"
      },
      "panels": [
        {
          "id": 1,
          "title": "Total Requests (5m rate)",
          "type": "stat",
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 0
          },
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area",
            "reduceOptions": {
              "calcs": [
                "sum"
              ]
            }
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "thresholds": {
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "loki",
                "uid": "loki"
              },
              "expr": "sum(count_over_time({namespace=\"default\", container=\"consul-dataplane\"} [5m]))",
              "legendFormat": "requests",
              "refId": "A"
            }
          ]
        },
        {
          "id": 2,
          "title": "5xx Errors (5m rate)",
          "type": "stat",
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 0
          },
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "options": {
            "colorMode": "background",
            "graphMode": "area",
            "reduceOptions": {
              "calcs": [
                "sum"
              ]
            }
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "thresholds": {
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 1
                  }
                ]
              },
              "unit": "short"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "loki",
                "uid": "loki"
              },
              "expr": "sum(count_over_time({namespace=\"default\", container=\"consul-dataplane\"} | json | response_code >= 500 [5m]))",
              "legendFormat": "5xx",
              "refId": "A"
            }
          ]
        },
        {
          "id": 3,
          "title": "Request Rate by Service",
          "type": "timeseries",
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 4
          },
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "reqps",
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "fillOpacity": 10,
                "lineWidth": 1
              }
            }
          },
          "options": {
            "legend": {
              "calcs": [
                "mean"
              ],
              "displayMode": "table",
              "placement": "bottom"
            },
            "tooltip": {
              "mode": "multi"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "loki",
                "uid": "loki"
              },
              "expr": "sum by (app) (rate({namespace=\"default\", container=\"consul-dataplane\"} [1m]))",
              "legendFormat": "{{app}}",
              "refId": "A"
            }
          ]
        },
        {
          "id": 4,
          "title": "Error Rate by Service",
          "type": "timeseries",
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 4
          },
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "reqps",
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "fillOpacity": 10,
                "lineWidth": 1
              }
            }
          },
          "options": {
            "legend": {
              "calcs": [
                "mean"
              ],
              "displayMode": "table",
              "placement": "bottom"
            },
            "tooltip": {
              "mode": "multi"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "loki",
                "uid": "loki"
              },
              "expr": "sum by (app) (rate({namespace=\"default\", container=\"consul-dataplane\"} | json | response_code >= 500 [1m]))",
              "legendFormat": "{{app}} 5xx",
              "refId": "A"
            }
          ]
        },
        {
          "id": 5,
          "title": "Live Log Stream",
          "type": "logs",
          "gridPos": {
            "h": 12,
            "w": 24,
            "x": 0,
            "y": 12
          },
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "options": {
            "dedupStrategy": "none",
            "enableLogDetails": true,
            "showTime": true,
            "sortOrder": "Descending",
            "wrapLogMessage": true
          },
          "targets": [
            {
              "datasource": {
                "type": "loki",
                "uid": "loki"
              },
              "expr": "{namespace=\"default\", container=\"consul-dataplane\"}",
              "legendFormat": "",
              "refId": "A"
            }
          ]
        }
      ]
    }
  gateways.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "API Gateway (north-south) and Terminating Gateway (mesh-to-external) metrics. Queries support both Docker (job label) and K8s (service label) environments.",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "links": [],
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "API Gateway  (north-south entry point: client \u2192 API GW \u2192 web)",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "Requests per second entering the API Gateway. Docker: job='api-gateway'. K8s: service='api-gateway'.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  },
                  {
                    "color": "green",
                    "value": 0.1
                  }
                ]
              },
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "options": {
            "colorMode": "background",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "showPercentChange": false,
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "Request Rate",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_http_downstream_rq_total{job=\"api-gateway\"}[1m]))",
              "legendFormat": "Docker",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_http_downstream_rq_total{service=\"api-gateway\"}[1m]))",
              "legendFormat": "K8s",
              "refId": "B"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "Percentage of requests returning 5xx errors through the API Gateway.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 5
                  },
                  {
                    "color": "red",
                    "value": 15
                  }
                ]
              },
              "unit": "percent",
              "min": 0,
              "max": 100
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 1
          },
          "id": 3,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "Error Rate (5xx)",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "100 * sum(rate(envoy_http_downstream_rq_5xx{job=\"api-gateway\"}[1m])) / clamp_min(sum(rate(envoy_http_downstream_rq_total{job=\"api-gateway\"}[1m])), 0.001)",
              "legendFormat": "Docker",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "100 * sum(rate(envoy_http_downstream_rq_5xx{service=\"api-gateway\"}[1m])) / clamp_min(sum(rate(envoy_http_downstream_rq_total{service=\"api-gateway\"}[1m])), 0.001)",
              "legendFormat": "K8s",
              "refId": "B"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "99th percentile request latency at the API Gateway listener (ms).",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 100
                  },
                  {
                    "color": "red",
                    "value": 500
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 1
          },
          "id": 4,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "P99 Latency",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{job=\"api-gateway\"}[1m])) by (le))",
              "legendFormat": "Docker",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{service=\"api-gateway\"}[1m])) by (le))",
              "legendFormat": "K8s",
              "refId": "B"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "Requests dropped by the local rate limiter (100 req/s fill, burst 200). Non-zero means the gateway is under load. Docker only \u2014 K8s API Gateway uses Envoy xDS-managed rate limiting.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 1
                  },
                  {
                    "color": "red",
                    "value": 10
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 1
          },
          "id": 5,
          "options": {
            "colorMode": "background",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "Rate Limited (last 5m)",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(increase(envoy_http_local_rate_limiter_rate_limited{job=\"api-gateway\"}[5m]))",
              "legendFormat": "Docker",
              "refId": "A"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "API Gateway request rate broken down by HTTP response class.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 2,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "reqps"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "5xx"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "red",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "4xx"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "orange",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "2xx"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "green",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 5
          },
          "id": 6,
          "options": {
            "legend": {
              "calcs": [
                "mean",
                "lastNotNull"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "none"
            }
          },
          "title": "Request Rate by Status Class",
          "type": "timeseries",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_http_downstream_rq_2xx{job=\"api-gateway\"}[1m]))",
              "legendFormat": "2xx",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_http_downstream_rq_4xx{job=\"api-gateway\"}[1m]))",
              "legendFormat": "4xx",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_http_downstream_rq_5xx{job=\"api-gateway\"}[1m]))",
              "legendFormat": "5xx",
              "refId": "C"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_http_downstream_rq_2xx{service=\"api-gateway\"}[1m]))",
              "legendFormat": "2xx (K8s)",
              "refId": "D"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_http_downstream_rq_5xx{service=\"api-gateway\"}[1m]))",
              "legendFormat": "5xx (K8s)",
              "refId": "E"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "API Gateway request latency percentiles. Measures full round-trip time from gateway listener to upstream response.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 5,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 2,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 5
          },
          "id": 7,
          "options": {
            "legend": {
              "calcs": [
                "mean",
                "lastNotNull"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "none"
            }
          },
          "title": "Latency Percentiles",
          "type": "timeseries",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.50, sum(rate(envoy_http_downstream_rq_time_bucket{job=\"api-gateway\"}[1m])) by (le))",
              "legendFormat": "P50",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.95, sum(rate(envoy_http_downstream_rq_time_bucket{job=\"api-gateway\"}[1m])) by (le))",
              "legendFormat": "P95",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{job=\"api-gateway\"}[1m])) by (le))",
              "legendFormat": "P99",
              "refId": "C"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_http_downstream_rq_time_bucket{service=\"api-gateway\"}[1m])) by (le))",
              "legendFormat": "P99 (K8s)",
              "refId": "D"
            }
          ]
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 13
          },
          "id": 8,
          "panels": [],
          "title": "Terminating Gateway  (mesh-to-external: currency \u2192 TGW \u2192 rates)",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "Requests per second proxied by the Terminating Gateway to the external rates service.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  },
                  {
                    "color": "green",
                    "value": 0.1
                  }
                ]
              },
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 14
          },
          "id": 9,
          "options": {
            "colorMode": "background",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "External RPS",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_cluster_upstream_rq_total{job=\"terminating-gateway\"}[1m]))",
              "legendFormat": "Docker",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_cluster_upstream_rq_total{service=\"terminating-gateway\"}[1m]))",
              "legendFormat": "K8s",
              "refId": "B"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "Percentage of requests to the external rates service returning 5xx errors.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 5
                  },
                  {
                    "color": "red",
                    "value": 15
                  }
                ]
              },
              "unit": "percent",
              "min": 0,
              "max": 100
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 14
          },
          "id": 10,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "External Error Rate",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "100 * sum(rate(envoy_cluster_upstream_rq_5xx{job=\"terminating-gateway\"}[1m])) / clamp_min(sum(rate(envoy_cluster_upstream_rq_total{job=\"terminating-gateway\"}[1m])), 0.001)",
              "legendFormat": "Docker",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "100 * sum(rate(envoy_cluster_upstream_rq_5xx{service=\"terminating-gateway\"}[1m])) / clamp_min(sum(rate(envoy_cluster_upstream_rq_total{service=\"terminating-gateway\"}[1m])), 0.001)",
              "legendFormat": "K8s",
              "refId": "B"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "99th percentile upstream latency from the Terminating Gateway to the external rates service.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 50
                  },
                  {
                    "color": "red",
                    "value": 200
                  }
                ]
              },
              "unit": "ms"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 14
          },
          "id": 11,
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "External P99 Latency",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket{job=\"terminating-gateway\"}[1m])) by (le))",
              "legendFormat": "Docker",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket{service=\"terminating-gateway\"}[1m])) by (le))",
              "legendFormat": "K8s",
              "refId": "B"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "Number of open connections from the Terminating Gateway to the external rates service.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  },
                  {
                    "color": "green",
                    "value": 1
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 14
          },
          "id": 12,
          "options": {
            "colorMode": "background",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "title": "Active Connections",
          "type": "stat",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(envoy_cluster_upstream_cx_active{job=\"terminating-gateway\"})",
              "legendFormat": "Docker",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(envoy_cluster_upstream_cx_active{service=\"terminating-gateway\"})",
              "legendFormat": "K8s",
              "refId": "B"
            }
          ]
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "description": "Request rate and latency for the currency \u2192 Terminating Gateway \u2192 rates (external) call path. Latency spikes here indicate the external service is slow, not the mesh.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "opacity",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 2,
                "pointSize": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "reqps"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "P99 ms"
                },
                "properties": [
                  {
                    "id": "custom.axisPlacement",
                    "value": "right"
                  },
                  {
                    "id": "unit",
                    "value": "ms"
                  },
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "orange",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "5xx"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "red",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 18
          },
          "id": 13,
          "options": {
            "legend": {
              "calcs": [
                "mean",
                "lastNotNull",
                "max"
              ],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "none"
            }
          },
          "title": "External Service Calls  (currency \u2192 TGW \u2192 rates)",
          "type": "timeseries",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_cluster_upstream_rq_total{job=\"terminating-gateway\"}[1m]))",
              "legendFormat": "RPS",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_cluster_upstream_rq_5xx{job=\"terminating-gateway\"}[1m]))",
              "legendFormat": "5xx",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket{job=\"terminating-gateway\"}[1m])) by (le))",
              "legendFormat": "P99 ms",
              "refId": "C"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "sum(rate(envoy_cluster_upstream_rq_total{service=\"terminating-gateway\"}[1m]))",
              "legendFormat": "RPS (K8s)",
              "refId": "D"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "prometheus"
              },
              "expr": "histogram_quantile(0.99, sum(rate(envoy_cluster_upstream_rq_time_bucket{service=\"terminating-gateway\"}[1m])) by (le))",
              "legendFormat": "P99 ms (K8s)",
              "refId": "E"
            }
          ]
        }
      ],
      "refresh": "15s",
      "schemaVersion": 39,
      "tags": [
        "consul",
        "envoy",
        "gateway"
      ],
      "time": {
        "from": "now-30m",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Consul Gateways",
      "uid": "consul-gateways",
      "version": 1
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: observability
data:
  datasources.yml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        uid: prometheus
        url: http://prometheus.observability.svc.cluster.local:9090
        access: proxy
        isDefault: true
        editable: false
        jsonData:
          httpMethod: POST
          timeInterval: "15s"

      - name: Loki
        type: loki
        uid: loki
        url: http://loki.observability.svc.cluster.local:3100
        access: proxy
        editable: false
        jsonData:
          maxLines: 1000
          derivedFields:
            - name: TraceID
              matcherRegex: '"traceparent":"00-([0-9a-f]{32})-'
              url: "$${__value.raw}"
              datasourceUid: jaeger

      - name: Jaeger
        type: jaeger
        uid: jaeger
        url: http://jaeger-query.observability.svc.cluster.local:16686
        access: proxy
        editable: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: observability
data:
  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: consul-observability
        folder: Consul Observability
        type: file
        disableDeletion: true
        updateIntervalSeconds: 30
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: observability
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
      annotations:
        consul.hashicorp.com/connect-inject: "false"
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:10.4.3
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: admin
            - name: GF_SECURITY_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: grafana-secret
                  key: password
                  optional: true  # falls back to GF_SECURITY_ADMIN_PASSWORD default
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: admin        # override in production via secret
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "false"
            - name: GF_EXPLORE_ENABLED
              value: "true"
          ports:
            - containerPort: 3000
              name: http
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboard-provider
              mountPath: /etc/grafana/provisioning/dashboards
            - name: dashboards
              mountPath: /var/lib/grafana/dashboards
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
      volumes:
        - name: datasources
          configMap:
            name: grafana-datasources
        - name: dashboard-provider
          configMap:
            name: grafana-dashboard-provider
        - name: dashboards
          configMap:
            name: grafana-dashboards
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: observability
  labels:
    app: grafana
spec:
  selector:
    app: grafana
  ports:
    - name: http
      port: 3000
      targetPort: 3000
  type: ClusterIP
