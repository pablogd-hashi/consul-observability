# kubernetes/consul/config-entries/service-defaults-fake-service.yaml
# Sets protocol=http for all fake-service services so Consul can apply L7
# traffic management (intentions, circuit breaking, load balancing) and
# Envoy will generate per-request metrics (not just per-connection TCP metrics).
---
apiVersion: consul.hashicorp.com/v1alpha1
kind: ServiceDefaults
metadata:
  name: web
  namespace: default
spec:
  protocol: http
---
apiVersion: consul.hashicorp.com/v1alpha1
kind: ServiceDefaults
metadata:
  name: api
  namespace: default
spec:
  protocol: http
  # Outlier detection: Envoy ejects a failing upstream after 3 consecutive 5xx.
  # Requests to ejected backends immediately return 503 (circuit open).
  upstreamConfig:
    defaults:
      outlierDetection:
        consecutive5xx: 3
        interval: 10s
        baseEjectionTime: 30s
---
apiVersion: consul.hashicorp.com/v1alpha1
kind: ServiceDefaults
metadata:
  name: payments
  namespace: default
spec:
  protocol: http
  upstreamConfig:
    defaults:
      outlierDetection:
        consecutive5xx: 3
        interval: 10s
        baseEjectionTime: 30s
---
apiVersion: consul.hashicorp.com/v1alpha1
kind: ServiceDefaults
metadata:
  name: cache
  namespace: default
spec:
  protocol: http
---
apiVersion: consul.hashicorp.com/v1alpha1
kind: ServiceDefaults
metadata:
  name: currency
  namespace: default
spec:
  protocol: http
