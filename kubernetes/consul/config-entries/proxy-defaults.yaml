# kubernetes/consul/config-entries/proxy-defaults.yaml
# Global Envoy proxy configuration applied to ALL sidecars in the mesh.
# Mirrors the HCL config in: shared/consul/proxy-defaults.hcl
#
# Apply: kubectl apply -f proxy-defaults.yaml -n consul
# Or:    consul config write proxy-defaults.yaml  (if using Consul CLI)

apiVersion: consul.hashicorp.com/v1alpha1
kind: ProxyDefaults
metadata:
  name: global
  namespace: consul
spec:
  # ── Prometheus metrics ──────────────────────────────────────────────────
  # Expose Envoy stats on port 20200 for Prometheus scraping.
  # connectInject.metrics.defaultEnableMerging=true in Helm values merges
  # these with app metrics automatically.
  config:
    envoy_prometheus_bind_addr: "0.0.0.0:20200"

    # ── Envoy tracing (Zipkin → OTel Collector → Jaeger) ─────────────────
    # shared_span_context=true propagates W3C traceparent across services.
    envoy_tracing_json: |
      {
        "http": {
          "name": "envoy.tracers.zipkin",
          "typedConfig": {
            "@type": "type.googleapis.com/envoy.config.trace.v3.ZipkinConfig",
            "collector_cluster": "otel_zipkin",
            "collector_endpoint_version": "HTTP_JSON",
            "collector_endpoint": "/api/v2/spans",
            "shared_span_context": true
          }
        }
      }

    # Static cluster pointing to the OTel Collector Zipkin receiver.
    # The address should match the OTel Collector Service DNS name in k8s.
    envoy_extra_static_clusters_json: |
      {
        "name": "otel_zipkin",
        "type": "STRICT_DNS",
        "connect_timeout": "5s",
        "load_assignment": {
          "cluster_name": "otel_zipkin",
          "endpoints": [{
            "lb_endpoints": [{
              "endpoint": {
                "address": {
                  "socket_address": {
                    "address": "otel-collector.observability.svc.cluster.local",
                    "port_value": 9411
                  }
                }
              }
            }]
          }]
        }
      }

  # ── Envoy access logs ────────────────────────────────────────────────────
  # Structured JSON access logs written to stdout of the consul-dataplane
  # sidecar container. Promtail scrapes the container stdout and labels them
  # service_name=envoy-sidecar / log_source=access-log so the Grafana
  # "Envoy Access Logs" dashboard can parse them with LogQL | json.
  #
  # Field names match the Grafana dashboard LogQL queries:
  #   {service_name="envoy-sidecar"} | json | http_status_code >= 500
  #   {service_name="envoy-sidecar"} | json | duration > 1000
  accessLogs:
    enabled: true
    type: stdout
    jsonFormat: '{"start_time":"%START_TIME%","method":"%REQ(:METHOD)%","path":"%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%","protocol":"%PROTOCOL%","http_status_code":"%RESPONSE_CODE%","response_flags":"%RESPONSE_FLAGS%","bytes_received":"%BYTES_RECEIVED%","bytes_sent":"%BYTES_SENT%","duration":"%DURATION%","upstream_cluster":"%UPSTREAM_CLUSTER%","upstream_host":"%UPSTREAM_HOST%","authority":"%REQ(:AUTHORITY)%","request_id":"%REQ(X-REQUEST-ID)%"}'
